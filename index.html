<html><head><base href=""><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seguimiento de Repartidor en Bariloche</title>

<script src='https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.js'></script>
<link href='https://unpkg.com/maplibre-gl@3.0.0/dist/maplibre-gl.css' rel='stylesheet' />

<style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .delivery-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1;
        width: 300px;
    }
    .driver-info {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .driver-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #f0f0f0;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .status {
        padding: 5px 10px;
        border-radius: 15px;
        background: #e8f5e9;
        color: #2e7d32;
        display: inline-block;
        margin-top: 5px;
    }
    .address-input, .whatsapp-input {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    #search-button, #share-button, #location-button {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #search-button:hover, #share-button:hover, #location-button:hover {
        background: #45a049;
    }
    #share-button {
        background: #25D366;
    }
    #share-button:hover {
        background: #128C7E;
    }
    .marker {
        background: none;
        border: none;
    }
    .delivery-marker {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .marker-text {
        background: #FF0000;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        white-space: nowrap;
        margin-bottom: 2px;
    }
    .delivery-marker svg {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
</style>
</head>
<body>
<div class="delivery-info">
    <div class="driver-info">
        <div class="driver-avatar">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="#666">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <div>
            <h3 style="margin: 0">Jonatan Gaylord</h3>
            <span>Repartidor #4321</span>
        </div>
    </div>
    <div class="status">En camino</div>
    <div id="eta">Tiempo estimado: 15 min</div>
    <button id="location-button">Usar mi ubicación actual</button>
    <input type="text" class="address-input" id="address-input" placeholder="Ingresa la dirección de entrega">
    <button id="search-button">Buscar Dirección</button>
    <input type="tel" class="whatsapp-input" id="whatsapp-input" placeholder="Número de WhatsApp (ej: 5492944123456)">
    <button id="share-button">Compartir por WhatsApp</button>
</div>

<div id="map"></div>

<script>
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        sources: {
            'osm': {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '© OpenStreetMap contributors'
            }
        },
        layers: [{
            id: 'osm',
            type: 'raster',
            source: 'osm',
            minzoom: 0,
            maxzoom: 19
        }]
    },
    center: [-71.3082, -41.1334],
    zoom: 15
});

const createDeliveryMarker = () => {
    const el = document.createElement('div');
    el.className = 'delivery-marker';
    el.innerHTML = `
        <div class="marker-text">Cerodistancia</div>
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" 
                  fill="#FF0000"/>
            <circle cx="12" cy="9" r="3" fill="white"/>
        </svg>
    `;
    return el;
};

const createHouseMarker = () => {
    const el = document.createElement('div');
    el.className = 'marker';
    el.innerHTML = `
        <svg viewBox="0 0 24 24" fill="#4CAF50">
            <path d="M12 3L4 9v12h16V9l-8-6zm0 2.7L18 11v8H6v-8l6-5.3z"/>
            <path d="M12 12c-1.1 0-2 .9-2 2v3h4v-3c0-1.1-.9-2-2-2z"/>
        </svg>
    `;
    return el;
};

const driverMarker = new maplibregl.Marker({
    element: createDeliveryMarker(),
    anchor: 'center'
});

let destinationMarker = new maplibregl.Marker({
    element: createHouseMarker(),
    anchor: 'bottom'
});

let currentPosition = {
    lng: -71.3082,
    lat: -41.1334
};

map.addControl(new maplibregl.NavigationControl());

function getUserLocation() {
    if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalización');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const userCoords = [position.coords.longitude, position.coords.latitude];
            
            destinationMarker.setLngLat(userCoords).addTo(map);
            
            map.flyTo({
                center: userCoords,
                zoom: 17
            });
            
            updateRoute(userCoords);
        },
        (error) => {
            console.error('Error getting location:', error);
            alert('Error al obtener tu ubicación. Por favor intenta con una dirección manual.');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

document.getElementById('location-button').addEventListener('click', getUserLocation);

async function searchAddress(address) {
    const query = encodeURIComponent(address + ', Bariloche, Argentina');
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&addressdetails=1`);
        const data = await response.json();
        
        if (data.length > 0) {
            const location = data[0];
            const coordinates = [parseFloat(location.lon), parseFloat(location.lat)];
            
            destinationMarker.setLngLat(coordinates).addTo(map);
            
            map.flyTo({
                center: coordinates,
                zoom: 17
            });
            
            updateRoute(coordinates);
        } else {
            alert('Dirección no encontrada. Por favor intenta con otra dirección.');
        }
    } catch (error) {
        console.error('Error al buscar la dirección:', error);
        alert('Error al buscar la dirección. Por favor intenta de nuevo.');
    }
}

async function updateRoute(destinationCoords) {
    const start = [currentPosition.lng, currentPosition.lat];
    const end = destinationCoords;
    
    try {
        const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson`);
        const data = await response.json();
        
        if (data.code === 'Ok' && data.routes.length > 0) {
            const route = data.routes[0].geometry;
            
            if (map.getSource('route')) {
                map.getSource('route').setData({
                    type: 'Feature',
                    properties: {},
                    geometry: route
                });
            } else {
                map.addSource('route', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: route
                    }
                });
                
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#0066FF',
                        'line-width': 4,
                        'line-opacity': 0.7
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error al actualizar la ruta:', error);
    }
}

function shareOnWhatsApp() {
    const whatsappNumber = document.getElementById('whatsapp-input').value.replace(/\D/g, '');
    if (!whatsappNumber) {
        alert('Por favor ingresa un número de WhatsApp válido');
        return;
    }
    
    const trackingUrl = window.location.href;
    const message = encodeURIComponent(`¡Hola! Sigue tu pedido de Cerodistancia en tiempo real aquí: ${trackingUrl}`);
    const whatsappUrl = `https://api.whatsapp.com/send?phone=${whatsappNumber}&text=${message}`;
    
    window.open(whatsappUrl, '_blank');
}

function updateDriverPosition() {
    currentPosition.lng += (Math.random() - 0.5) * 0.001;
    currentPosition.lat += (Math.random() - 0.5) * 0.001;
    
    driverMarker.setLngLat([currentPosition.lng, currentPosition.lat]).addTo(map);
    
    if (destinationMarker.getLngLat()) {
        updateRoute([destinationMarker.getLngLat().lng, destinationMarker.getLngLat().lat]);
    }
    
    const eta = Math.floor(Math.random() * 10 + 5);
    document.getElementById('eta').textContent = `Tiempo estimado: ${eta} min`;
}

document.getElementById('search-button').addEventListener('click', () => {
    const address = document.getElementById('address-input').value;
    if (address) {
        searchAddress(address);
    }
});

document.getElementById('share-button').addEventListener('click', shareOnWhatsApp);

document.getElementById('address-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const address = document.getElementById('address-input').value;
        if (address) {
            searchAddress(address);
        }
    }
});

function updateDeliveryStatus() {
    const statusElement = document.querySelector('.status');
    const estados = ['Preparando pedido', 'En camino', 'Cerca de tu ubicación', 'Llegando'];
    let currentIndex = 1;

    setInterval(() => {
        statusElement.textContent = estados[currentIndex];
        currentIndex = (currentIndex + 1) % estados.length;
    }, 10000);
}

map.on('load', () => {
    driverMarker.setLngLat([currentPosition.lng, currentPosition.lat]).addTo(map);
    setInterval(updateDriverPosition, 2000);
});

updateDeliveryStatus();

map.on('error', (e) => {
    console.error('Error en el mapa:', e);
    alert('Hubo un error al cargar el mapa. Por favor, intenta de nuevo más tarde.');
});
</script>

</body>
</html>